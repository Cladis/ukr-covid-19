<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>UKR COVID-19</title>
<script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet" />
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;600&display=swap" rel="stylesheet">
<meta name="format-detection" content="telephone=no">
<link rel="icon" href="img/favicon.png"> 
<meta property="og:image" content="img/fb.png">
<script src="js/mozdatagetter.js"></script>
<script src="js/mapdrawer.js"></script>
<script src="js/pageinteraction.js"></script>
<script src="js/rangelegenddata.js"></script>
<link rel="stylesheet" href="css/legend.css">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>

<link rel="stylesheet" href="likely/likely.css">
<script src="likely/likely.js"></script>

</head>
<body>

<div id="map"></div>

<div id="settings" class="settings">
  <div id="showHideSettings" onclick="showHide('settingsdetails', this.id)">сховати налаштування</div>
  <div id="settingsdetails">
    <div class="settingsseparation">
      <select id="data" class="settingsselector">
        <optgroup label="Показники МОЗ">
          <option value="Зайнято загалом хворими з COVID-19">Ліжок зайнято хворими на COVID-19</option>
          <option value="Лікарі, які вже працюють з пацієнтами з COVID-19">Лікарі зайняті з хворими на COVID-19</option>
          <option value="Всі лікарі, які можуть бути задіяні з COVID-19 (усі спеціальності)">Лікарі можуть бути зайняті з хворими COVID-19</option>
        </optgroup>
        <optgroup label="Аналіз показників">
          <option value="Зайнято загалом хворими з COVID-19|Лікарі, які вже працюють з пацієнтами з COVID-19">Паціентів з COVID-19 на одного лікаря</option>
          <option value="Лікарі, які вже працюють з пацієнтами з COVID-19|Зайнято загалом хворими з COVID-19">Лікарів на одно паціента з COVID-19</option>
          <option value="Зайнято загалом хворими з COVID-19|Загалом, ліжок виділено для госпіталізації хворих з COVID-19">Зайнято ліжок виділених на COVID-19</option>
          <option value="Зайнято реанімаційні / інтенсивної терапії|Реанімаційні / Інтенсивної терапії">Зайнято реанімаційних виділених на COVID-19</option>
        </optgroup>
      </select><br>
    </div>

   <div class="settingsseparation">
      <input type="number" id="day" class="settingsselector" inputmode="numeric">
      <select id="month" class="settingsselector">
        <option value="06">Червня</option>
        <option value="07">Липня</option>
        <option value="08">Серпня</option>
        <option value="09">Вересня</option>
        <option value="10">Жовтня</option>
        <option value="11">Листопада</option>
        <option value="12">Грудня</option>
      </select>
    
      <div hidden><input id="year" type="text"></div>
    </div>

    <button class="settingsselector" onclick="updateDataLayer()">Показати</button>
  </div>
</div>

<div id="obl-legend" class="legend">
 <div id=legendinfo>
  <div id="legendcolors">
    <div class="step-11"><span style="background-color:#8800A3"></span>500&nbsp+&nbsp&nbsp</div>
    <div class="step-10"><span style="background-color:#A000A3"></span>450&nbsp-&nbsp500&nbsp&nbsp</div>
    <div class="step-9"><span style="background-color:#9B15AD"></span>400&nbsp-&nbsp450&nbsp&nbsp</div>
    <div class="step-8"><span style="background-color:#962AB7"></span>350&nbsp-&nbsp400&nbsp&nbsp</div>
    <div class="step-7"><span style="background-color:#913FC1"></span>300&nbsp-&nbsp350&nbsp&nbsp</div>
    <div class="step-6"><span style="background-color:#8C54CB"></span>250&nbsp-&nbsp300&nbsp&nbsp</div>
    <div class="step-5"><span style="background-color:#8869D6"></span>200&nbsp-&nbsp250&nbsp&nbsp</div>
    <div class="step-4"><span style="background-color:#837EE0"></span>150&nbsp-&nbsp200&nbsp&nbsp</div>
    <div class="step-3"><span style="background-color:#7E93EA"></span>100&nbsp-&nbsp150&nbsp&nbsp</div>
    <div class="step-2"><span style="background-color:#79A8F4"></span>50&nbsp-&nbsp100&nbsp&nbsp</div>
    <div class="step-1"><span style="background-color:#75BEFF"></span>1&nbsp-&nbsp50&nbsp&nbsp</div>
  </div>
</div>
<div id="showHideLegend" onclick="showHide('legendinfo', this.id)">сховати легенду</div>
</div>

<div class="info">
  <div id="info" style="margin-bottom: 5px; display: none;">
    <p>відкриті дані <a href="https://covid19.gov.ua/analitichni-paneli-dashbordy" target="blank">МОЗ</a><br>
    візуалізація <a href="https://siniavtsev.io" target="blank">siniavtsev.io</a></p>
  </div>

  <div class="infoandshare">
    <div id="showHideInfo" class="infoentry" onclick="showHide('info')">
      <span style="opacity: 0.7;">інфо</span>
    </div>
    <div class="likely likely-light likely-small infoentry" data-counters="no">
      <div class="twitter" data-via="beyond_danube"></div>
      <div class="telegram"></div>
      <div class="facebook"></div>
  </div>
</div>

<script>

setDateToSelector();


mapboxgl.accessToken = 'pk.eyJ1IjoiYmV5b25kLWRhbnViZSIsImEiOiJja2hheTFhaXgwMms0MnlvZzUyZml3ZDA1In0.m40ntsAMPxPktC2gdI_VyQ';
  let map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/beyond-danube/ckhdxe13i040319pvcygzixmu',
  center: [31.1828699, 48.383022],
  zoom: 5
});

map.on('load', function() {

  map.addSource('ukradm', {
    type: 'vector',
    url: 'mapbox://beyond-danube.16wn2ahv'
  });

  updateDataLayer()
});

function updateDataLayer(){

  let day = transformData(getDateFromSelector());

  if(map.getLayer('ukradm-join'))
  {
    map.removeLayer('ukradm-join')
  }
  

  let drawData = function(result){ 
    
    drawdata = result;

    let matchExpression = ['match', ['get', 'ADM1_PCODE']];

    drawdata.data.forEach(function(row) {
    matchExpression.push(row['ADM1_PCODE'], getColor(row['DATA'], lienarGradientBluePurple, getRangeFormSelector()));
  });

  // Last value is the default, used where there is no data
  matchExpression.push('rgba(0, 0, 0, 0)');

  map.addLayer({
    'id': 'ukradm-join',
    'type': 'fill',
    'source': 'ukradm',
    'source-layer': 'ukr_admbnda_adm1_q2_sspe_2017-9lhdux',
    'paint': {
      'fill-color': matchExpression,
      'fill-opacity': 0.7
      }
    }, 'water');
  };

  getDatabyGeoRegion(day,
    document.getElementById('data').value)
  .then(drawData);
}

document.getElementById('data').addEventListener('change', changeColorValuesToDataFromSelector);

</script>
</body>
</html>